import fs from "fs/promises";

let cachedCodebook = null;

/**
 * Loads the codebook JSON file once and caches it.
 */
export async function loadCodebook() {
  if (!cachedCodebook) {
    const raw = await fs.readFile("standardized_codebook.json", "utf8");
    cachedCodebook = JSON.parse(raw);
  }
  return cachedCodebook;
}

/**
 * Matches comment text against codebook keywords.
 * Returns an array of categories that matched.
 */
export async function matchThemes(commentText) {
  const codebook = await loadCodebook();
  const text = commentText.toLowerCase();
  const matchedThemes = [];

  for (const entry of codebook) {
    for (const phrase of entry.examples) {
      if (text.includes(phrase.toLowerCase())) {
        matchedThemes.push(entry.category);
        break; // only add one match per category
      }
    }
  }

  return [...new Set(matchedThemes)];
}
