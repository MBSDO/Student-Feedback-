console.log("Loading DB Module");

import dotenv from "dotenv";
dotenv.config();

import pkg from "pg";
import { exec } from "child_process";
import path from "path";
import fs from "fs";

const { Pool } = pkg;

export const dbConfig = {
  host: process.env.DB_HOST || "localhost",
  port: process.env.DB_PORT || 5432,
  user: process.env.DB_USER,
  password: process.env.DB_PW,
  database: process.env.DB_NAME,
  ssl: process.env.DB_SSL === "true" ? { rejectUnauthorized: false } : false,
};

export class DBConn {
  constructor(config = dbConfig) {
    console.log("Establishing PostgreSQL DB Connection");
    this.pool = new Pool(config);
  }

  async query(sql, values) {
    try {
      const result = await this.pool.query(sql, values);
      return result.rows;
    } catch (err) {
      console.error("PostgreSQL Query Error:", err.message);
      throw err;
    }
  }

  async testConnection() {
    try {
      await this.pool.query("SELECT 1");
      console.log("âœ… PostgreSQL database connected successfully.");
      return true;
    } catch (error) {
      console.error("âŒ PostgreSQL connection test failed:", error.message);
      return false;
    }
  }

  async close() {
    await this.pool.end();
  }
}

export const db = new DBConn();

export function checkPythonDependencies() {
  // âœ… Default to system python3
  let pythonPath = "python3";

  // âœ… Use local venv Python if available
  const localVenvPython = path.resolve(
    process.cwd(),
    "venv",
    process.platform === "win32" ? "Scripts/python.exe" : "bin/python3"
  );

  // âœ… Use venv Python if it exists (for local dev)
  if (fs.existsSync(localVenvPython)) {
    pythonPath = localVenvPython;
  }

  return new Promise((resolve, reject) => {
    exec(
      `"${pythonPath}" -m pip show psycopg2-binary openai`,
      (error, stdout, stderr) => {
        if (error) {
          console.error("âŒ Python package check error:", error.message);
          reject(error);
        } else if (stderr && stderr.includes("not found")) {
          console.error("âŒ Python stderr:", stderr);
          reject(new Error(stderr));
        } else {
          console.log("ðŸ Python packages installed:\n", stdout);
          resolve(true);
        }
      }
    );
  });
}

export async function startServer(app, port) {
  const isDbConnected = await db.testConnection();
  if (!isDbConnected) {
    console.error("âŒ Database not connected. Aborting server startup.");
    process.exit(1);
  }

  try {
    await checkPythonDependencies();
  } catch {
    console.error("âŒ Python dependencies missing. Aborting server startup.");
    process.exit(1);
  }

  app.listen(port, () => {
    console.log(`ðŸš€ Server running on http://localhost:${port}`);
  });
}
