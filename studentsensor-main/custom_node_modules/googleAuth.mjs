import express from "express";
import path from "path";
import https from "https";
import dotenv from "dotenv";
import { fileURLToPath } from "url";
import { dirname, resolve } from "path";

import { User } from "./user.mjs";

dotenv.config(); // Load .env

// Compute current directory
const __filename = fileURLToPath(import.meta.url);
const __dirname = dirname(__filename);

// Initialize router
export const GoogleAuthRouter = express.Router();

/**
 * Exchange authorization code for access token
 */
async function CheckToken(code, scope, redirect_uri) {
  const requestData = JSON.stringify({
    grant_type: "authorization_code",
    code: code,
    client_id: process.env.GOOGLE_CLIENT_ID,
    client_secret: process.env.GOOGLE_CLIENT_SECRET,
    redirect_uri: redirect_uri,
    scope: scope,
  });

  const options = {
    hostname: "oauth2.googleapis.com",
    port: 443,
    path: "/token",
    method: "POST",
    headers: {
      "Content-Type": "application/json",
      "Content-Length": requestData.length,
    },
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = "";
      res.on("data", (chunk) => (data += chunk));
      res.on("end", () => {
        const response = JSON.parse(data);
        response.status = "success";
        resolve(response);
      });
    });

    req.on("error", (error) => {
      reject({ status: "error", error });
    });

    req.setTimeout(5000, () => {
      reject({
        status: "error",
        error: "Connection timeout: Unable to connect to the server.",
      });
    });

    req.write(requestData);
    req.end();
  });
}

/**
 * Use token to fetch Google account info
 */
async function GetAccountData(token) {
  const options = {
    hostname: "people.googleapis.com",
    port: 443,
    path: "/v1/people/me?personFields=emailAddresses,names",
    method: "GET",
    headers: {
      "Content-Type": "application/json",
      Authorization: "Bearer " + token,
    },
  };

  return new Promise((resolve, reject) => {
    const req = https.request(options, (res) => {
      let data = "";
      res.on("data", (chunk) => (data += chunk));
      res.on("end", () => {
        const response = JSON.parse(data);
        response.status = "success";
        resolve(response);
      });
    });

    req.on("error", (error) => {
      reject({ status: "error", error });
    });

    req.setTimeout(5000, () => {
      reject({
        status: "error",
        error: "Connection timeout: Unable to connect to the server.",
      });
    });

    req.write("");
    req.end();
  });
}

/**
 * Handle Google OAuth2 callback
 */
GoogleAuthRouter.get("/callback", async (req, res) => {
  try {
    const tokenResponse = await CheckToken(
      req.query.code,
      req.query.scope,
      process.env.GOOGLE_CALLBACK_URL
    );

    if (
      tokenResponse.status === "success" &&
      tokenResponse.access_token &&
      tokenResponse.expires_in > 0
    ) {
      const accountData = await GetAccountData(tokenResponse.access_token);

      if (accountData.resourceName) {
        let uid = await new User().GetIDFromSetting(
          "google_resource_name",
          accountData.resourceName
        );

        let user;
        if (uid !== null) {
          user = await new User().Get(parseInt(uid));
        } else {
          user = await new User().Create();
          await user.SaveSetting(
            "google_resource_name",
            accountData.resourceName
          );
          await user.SaveSetting(
            "name",
            accountData.names?.[0]?.displayName || "Unnamed"
          );
          if (accountData.emailAddresses?.length > 0) {
            const email = accountData.emailAddresses[0].value;
            await user.SaveSetting("google_email", email);
            await user.SaveSetting("email", email);
          }
        }

        // Log in the user
        req.session.loggedin = true;
        user.Mask();
        await user.GetSettings();
        req.session.user = user;

        console.log("ðŸ‘¤ Account Data:", accountData);
        console.log("âœ… User session established:", req.session.user?.uid);

        return res.redirect("/");
      }
    }

    // If something failed
    console.error("OAuth failed:", tokenResponse);
    return res.sendFile(resolve(__dirname, "../public/pages/403.html"));
  } catch (err) {
    console.error("GoogleAuth callback error:", err);
    return res.sendFile(resolve(__dirname, "../public/pages/403.html"));
  }
});
