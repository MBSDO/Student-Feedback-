import dotenv from "dotenv";
dotenv.config();

const OPENAI_API_KEY = process.env.OPENAI_API_KEY;
const MODEL = process.env.OPENAI_MODEL || "gpt-4.1-mini";
const TEMPERATURE = Number(process.env.OPENAI_TEMPERATURE || 0.2);
const MAX_TOKENS = Number(process.env.OPENAI_MAX_TOKENS || 300);

export async function OpenAISendBatch(batch, codebook) {
  const prompt = buildRecodingPrompt(batch, codebook);

  const response = await fetch("https://api.openai.com/v1/chat/completions", {
    method: "POST",
    headers: {
      Authorization: `Bearer ${OPENAI_API_KEY}`,
      "Content-Type": "application/json",
    },
    body: JSON.stringify({
      model: MODEL,
      messages: [
        {
          role: "user",
          content: prompt,
        },
      ],
      temperature: TEMPERATURE,
      max_tokens: MAX_TOKENS,
    }),
  });

  const result = await response.json();

  if (!response.ok) {
    // ðŸ”‘ Fail fast, but clearly
    const message =
      result?.error?.message ||
      "OpenAI processing failed. Please try again later.";

    throw new Error(message);
  }

  const outputText = result.choices?.[0]?.message?.content;

  if (!outputText) {
    throw new Error("OpenAI returned empty output.");
  }

  try {
    return JSON.parse(outputText);
  } catch {
    throw new Error("OpenAI returned invalid JSON output.");
  }
}

function buildRecodingPrompt(batch, codebook) {
  let prompt = `
You are a qualitative researcher recoding student comments using a standardized codebook.

Use ONLY the categories in the codebook. Assign 1â€“3 categories per comment.
Return STRICT JSON only.

CODEBOOK:
${JSON.stringify(codebook, null, 2)}

FORMAT:
{
  "Comment 1": ["category"],
  "Comment 2": []
}

Now code the following comments:
`;

  batch.forEach((row, i) => {
    prompt += `\nComment ${i + 1}:\n${row.text}\n`;
  });

  return prompt;
}
