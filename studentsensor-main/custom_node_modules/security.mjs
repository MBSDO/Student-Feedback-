/**
 * Security utilities and middleware
 */

/**
 * Sanitize string input to prevent XSS
 */
export function sanitizeString(input) {
  if (typeof input !== "string") return "";
  return input
    .replace(/[<>]/g, "") // Remove < and >
    .trim()
    .slice(0, 10000); // Max length
}

/**
 * Validate and sanitize integer ID
 */
export function validateId(id, maxValue = 2147483647) {
  const num = parseInt(id);
  if (isNaN(num) || num < 1 || num > maxValue) {
    return null;
  }
  return num;
}

/**
 * Validate email format
 */
export function validateEmail(email) {
  if (typeof email !== "string") return false;
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  return emailRegex.test(email) && email.length <= 255;
}

/**
 * Validate text input (for names, course codes, etc.)
 */
export function validateText(input, maxLength = 255, allowEmpty = false) {
  if (typeof input !== "string") return null;
  const trimmed = input.trim();
  if (!allowEmpty && trimmed.length === 0) return null;
  if (trimmed.length > maxLength) return null;
  // Allow alphanumeric, spaces, hyphens, periods, parentheses
  if (!/^[a-zA-Z0-9\s\-\.\(\)]+$/.test(trimmed)) return null;
  return trimmed;
}

/**
 * Check if user is authenticated
 */
export function requireAuth(req, res, next) {
  if (!req.session || !req.session.user || !req.session.user.uid) {
    return res.status(401).json({ error: "Authentication required" });
  }
  next();
}

/**
 * Check if user owns the resource
 */
export function requireOwnership(req, res, next) {
  if (!req.session || !req.session.user || !req.session.user.uid) {
    return res.status(401).json({ error: "Authentication required" });
  }
  // This will be checked per-route based on resource ownership
  next();
}

/**
 * Rate limiting store (in-memory, simple implementation)
 */
const rateLimitStore = new Map();

/**
 * Simple rate limiting middleware
 */
export function rateLimit(maxRequests = 100, windowMs = 15 * 60 * 1000) {
  return (req, res, next) => {
    const key = req.ip || req.connection.remoteAddress || "unknown";
    const now = Date.now();
    const windowStart = now - windowMs;

    // Clean old entries
    if (rateLimitStore.has(key)) {
      const requests = rateLimitStore.get(key).filter((time) => time > windowStart);
      rateLimitStore.set(key, requests);
    } else {
      rateLimitStore.set(key, []);
    }

    const requests = rateLimitStore.get(key);

    if (requests.length >= maxRequests) {
      return res.status(429).json({
        error: "Too many requests. Please try again later.",
      });
    }

    requests.push(now);
    rateLimitStore.set(key, requests);
    next();
  };
}

/**
 * Security headers middleware
 */
export function securityHeaders(req, res, next) {
  // Prevent clickjacking
  res.setHeader("X-Frame-Options", "DENY");
  // Prevent MIME type sniffing
  res.setHeader("X-Content-Type-Options", "nosniff");
  // XSS protection
  res.setHeader("X-XSS-Protection", "1; mode=block");
  // Referrer policy
  res.setHeader("Referrer-Policy", "strict-origin-when-cross-origin");
  // Content Security Policy
  res.setHeader(
    "Content-Security-Policy",
    "default-src 'self'; script-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.jsdelivr.net; img-src 'self' data: https:; font-src 'self' data:; connect-src 'self' https://cdn.jsdelivr.net;"
  );
  next();
}

/**
 * Safe error response - don't leak sensitive info
 */
export function safeErrorResponse(err, isDevelopment = false) {
  const isDevelopmentMode = isDevelopment || process.env.NODE_ENV === "development";

  // Don't expose internal errors in production
  if (!isDevelopmentMode) {
    return {
      error: "An error occurred. Please try again later.",
    };
  }

  // In development, show more details
  return {
    error: err.message || "An error occurred",
    details: err.stack,
  };
}

/**
 * Validate CSV file size and content
 */
export function validateCSV(csvText, maxSizeMB = 10) {
  const maxSizeBytes = maxSizeMB * 1024 * 1024;
  
  if (typeof csvText !== "string") {
    return { valid: false, error: "CSV must be a string" };
  }

  if (csvText.length > maxSizeBytes) {
    return {
      valid: false,
      error: `CSV file too large. Maximum size is ${maxSizeMB}MB`,
    };
  }

  if (csvText.trim().length === 0) {
    return { valid: false, error: "CSV file is empty" };
  }

  // Check for suspicious content (basic check)
  if (csvText.includes("<script") || csvText.includes("javascript:")) {
    return { valid: false, error: "CSV contains invalid content" };
  }

  return { valid: true };
}

/**
 * Sanitize file path to prevent directory traversal
 */
export function sanitizeFilePath(filePath) {
  if (typeof filePath !== "string") return null;
  // Remove any path traversal attempts
  const sanitized = filePath
    .replace(/\.\./g, "")
    .replace(/\/\//g, "/")
    .replace(/^\/+/, "");
  return sanitized;
}
