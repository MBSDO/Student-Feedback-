<!DOCTYPE html>
<html lang="en" data-bs-theme="auto">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="description" content="Login for BYU Student Rating Analysis" />
    <title>BYU Student Rating Analysis Login</title>
    <link rel="stylesheet" href="/styles/bootstrap/css/bootstrap.min.css" />
    <link
      rel="stylesheet"
      href="/styles/bootstrap-icons/font/bootstrap-icons.min.css"
    />
    <link rel="stylesheet" href="/styles/styles.css?v=9" />
    <link rel="icon" href="/images/favicon.ico" type="image/x-icon" />
    <link rel="apple-touch-icon" href="/images/apple-touch-icon.png" />
    <style>
      #loginMenu button {
        color: var(--bs-primary);
      }

      #loginMenu button:hover,
      #loginMenu a:hover {
        background: var(--bs-primary);
        color: var(--bs-light) !important;
      }
    </style>
  </head>

  <body data-bs-theme="light">
    <div
      class="d-flex justify-content-center align-items-center vh-100 flex-column"
      id="loginMethods"
    >
      <div style="width: 400px">
        <img src="/images/byu_logo.svg" class="img-fluid" />
        <div
          class="fs-2 text-byu text-center mt-5 mb-3 bg-byu text-light py-3 rounded"
        >
          <span class="bi-table me-3"></span>Student Rating Analysis
        </div>
        <label class="fw-bold text-byu opacity-50 my-2">Log in with...</label>
        <nav id="loginMenu" class="list-group">
          <!--
                        <button class="list-group-item text-primary d-flex flex-row align-items-center ps-3 pe-4 w-100"
                            onclick="LoginGoogle();">
                            <i class="bi-key-fill fs-1 me-3"></i><span class="fs-3">BYU</span></button>
                    -->
          <button
            class="list-group-item text-primary d-flex flex-row align-items-center ps-3 pe-4 w-100"
            onclick="LoginGoogle();"
          >
            <i class="bi-google fs-1 me-3"></i><span class="fs-3">Google</span>
          </button>
          <!--
                <button class="list-group-item d-flex flex-row align-items-center ps-3 pe-4 w-100 text-primary"
                    data-bs-toggle="collapse" data-bs-target="#loginForm"><i class="bi-building fs-1 me-3"></i><span
                        class="fs-3">Other Account</span><i class="ms-auto bi-chevron-down fs-4"></i></button>
                <form id="loginForm" class="collapse px-3 py-2 bg-light list-group-item">
                    <div class="alert alert-light my-2" id="loginMessage" >This feature and SSO are temporarily disabled. Please use Google for now.</div>
                    <div class="form-floating mb-2">
                        <input type="text" class="form-control" id="username" name="username" placeholder="janedoe"
                            required>
                        <label for="username">Username</label>
                    </div>
                    <div class="form-floating mb-2">
                        <input type="password" class="form-control" id="password" name="password" placeholder="Password"
                            required>
                        <label for="password">Password</label>
                    </div>
                    <button role="submit" class="btn btn-primary text-light float-end"><i
                            class="bi-person me-2"></i>Login</button>
                </form>
                -->
        </nav>
      </div>
    </div>
    <script src="/js/jquery-3.7.1.min.js"></script>
    <script src="/styles/bootstrap/js/bootstrap.bundle.min.js"></script>
  </body>
  <script>
    $(document).ready(() => {
      $("#loginForm").on("submit", function (event) {
        event.preventDefault();
        InstitutionalLogin(
          $("input#username").val(),
          $("input#password").val()
        );
      });
    });
    async function LoginGoogle() {
      try {
        const res = await fetch("/env");
        const env = await res.json();
        const google_client_id = env.GOOGLE_CLIENT_ID;
        const google_callback =
          window.location.origin + "/auth/google/callback";
        console.log(google_client_id);
        console.log(google_callback);
        openOAuth2(
          "https://accounts.google.com/o/oauth2/v2/auth",
          google_client_id,
          google_callback,
          "email%20profile"
        );
      } catch (err) {
        console.error("âŒ Failed to load Google Client ID from /env:", err);
        alert("Unable to start Google login. Please try again later.");
      }
    }

    function openOAuth2(url, clientId, redirectUri, scope) {
      console.log("Attempting OAuth2 sign-in");
      url =
        url +
        "?client_id=" +
        clientId +
        "&response_type=code&scope=" +
        scope +
        "&show_login=false&redirect_uri=" +
        redirectUri;
      console.log(url);
      window.open(url, "_self");
    }
    async function InstitutionalLogin(username, password) {
      $("#loginMessage").remove();
      $(".is-invalid").removeClass("is-invalid");
      console.log("Logging in");
      return new Promise((resolve, reject) => {
        let data = {
          username: username,
          password: password,
        };
        let jsonData = JSON.stringify(data);
        $.ajax({
          url: "../../auth",
          type: "POST",
          data: jsonData,
          processData: false,
          contentType: "application/json",
          success: function (json) {
            //console.log(json);
            if (json.status == "success") {
              //console.log(json);
              window.location = json.redirect;
              resolve(json.entity);
            } else {
              for (let flag of json.flags) {
                $(flag).addClass("is-invalid").val("");
              }
              let m = $('<div class="alert alert-danger my-2"></div>');
              m.attr("id", "loginMessage");
              m.text(json.error);
              $("#loginForm").prepend(m);
              resolve(null);
            }
          },
          error: function (xhr, status, error) {
            console.log("error");
            reject(error);
          },
        });
      });
    }
  </script>
</html>
